<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <meta name="description" content="Lukas Woodtli">
    <meta name="author" content="Lukas Woodtli">

        <title>System Construction · Lukas Woodtli</title>


    <!-- Bootstrap core CSS -->
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css">

    <link rel="stylesheet" href="http://bootswatch.com/yeti/bootstrap.min.css" type="text/css">

    <link rel="stylesheet" href="http://lukaswoodtli.github.io/theme/css/main.css">

    <link rel="stylesheet" href="http://lukaswoodtli.github.io/theme/css/solarized-light.css">


    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>

    <script src="http://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>

    <script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>

</head>

<body>
  <div class="container" id="wrap">
      <nav id="navbar" class="navbar navbar-default" role="navigation">
    <div class="container">

      <!--navbar-header-->
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://lukaswoodtli.github.io">Lukas Woodtli</a>
      </div> <!--navbar-header-->

      <!-- Search Box -->

      <!--Menuitems, collapable-->
      <div class="collapse navbar-collapse" id="navbar-collapse">
        <ul class="nav navbar-nav navbar-right" id="menuitem-list">
                <li >
                  <a href="http://lukaswoodtli.github.io/index.html">Home</a>
                </li>

                <li >
                  <a href="http://lukaswoodtli.github.io/pages/cv.html">CV</a>
                </li>

              <li class="btn-group">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Skills<b class="caret"></b>
                </a>
                <ul class="dropdown-menu" role="menu">
                  <li >
                    <a href="http://lukaswoodtli.github.io/pages/skills.html">Hard Skills</a>
                  </li>
                  <li >
                    <a href="http://lukaswoodtli.github.io/pages/courses.html">Courses</a>
                  </li>
                  <li >
                    <a href="http://lukaswoodtli.github.io/pages/books.html">Books</a>
                  </li>
                  <li >
                    <a href="http://lukaswoodtli.github.io/pages/projects.html">Projects</a>
                  </li>
                </ul>
              </li>
              <li class="btn-group">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Blog<b class="caret"></b>
                </a>
                <ul class="dropdown-menu" role="menu">
                  <li >
                    <a href="http://lukaswoodtli.github.io/pages/blog.html">Blog Index</a>
                  </li>
                  <li >
                    <a href="http://lukaswoodtli.github.io/categories.html">Categories</a>
                  </li>
                  <li >
                    <a href="http://lukaswoodtli.github.io/tags.html">Tags</a>
                  </li>
                  <li >
                    <a href="http://lukaswoodtli.github.io/archives.html">Chronological</a>
                  </li>
                </ul>
              </li>
                <li >
                  <a href="http://lukaswoodtli.github.io/pages/contact.html">Contact</a>
                </li>

        </ul>
      </div><!-- /.navbar-collapse -->

    </div> <!--container-->
  </nav>


    <div class="container">
      <div class="col-md-2">
      </div>

      <div class="col-md-8">
        <div class="row">
              <div class="page-header">
        <h1><a href="http://lukaswoodtli.github.io/system_construction.html">System Construction</a></h1>
    </div>

        </div>

        <div class="row">

    <span id="article_info">
    <a class="label label-primary" 
      href="http://lukaswoodtli.github.io/category/programming.html">Programming</a>
      <b> · </b>
        <a class="label label-primary" 
          href="http://lukaswoodtli.github.io/tag/eth.html">ETH</a>
        <a class="label label-primary" 
          href="http://lukaswoodtli.github.io/tag/assembler.html">Assembler</a>
    <!--<span class="glyphicon glyphicon-calendar"></span>-->
      <b> · </b>
      <a href="http://lukaswoodtli.github.io/archives.html#Year2015">2015</a>-<a href="http://lukaswoodtli.github.io/archives.html#Year2015Month11">11</a>-<a href="http://lukaswoodtli.github.io/archives.html#Year2015Month11">07</a>

    <!--<span class="glyphicon glyphicon-user"></span>-->
      <b> · </b>
    <a href="http://lukaswoodtli.github.io/author/lukas_woodtli.html">Lukas Woodtli</a>
  </span>

  <hr/>

  <div id="article_content">
    <blockquote>
<p>My Notes for the <em>System Construction</em> Course at ETH</p>
</blockquote>
<div class="toc">
<ul>
<li><a href="#minos-on-raspberry-pi-2-case-study-1">Minos on Raspberry PI 2 (Case Study 1)</a><ul>
<li><a href="#arm-a7">ARM A7</a><ul>
<li><a href="#documentation">Documentation</a></li>
<li><a href="#6-kinds-of-instructions">6 Kinds Of Instructions</a></li>
<li><a href="#execution-modes">Execution Modes</a></li>
<li><a href="#special-registers">Special Registers</a></li>
<li><a href="#typical-procedure-call">Typical Procedure Call</a></li>
<li><a href="#exceptions">Exceptions</a></li>
<li><a href="#misc">Misc</a></li>
</ul>
</li>
<li><a href="#raspberry-pi-2">Raspberry PI 2</a><ul>
<li><a href="#booting">Booting</a></li>
<li><a href="#mmu">MMU</a></li>
<li><a href="#gpio">GPIO</a></li>
</ul>
</li>
<li><a href="#minos-and-oberon">Minos and Oberon</a><ul>
<li><a href="#history-of-oberon">History of Oberon</a></li>
<li><a href="#oberon">Oberon</a><ul>
<li><a href="#oberon07">Oberon07</a></li>
<li><a href="#language-constructs">Language Constructs</a><ul>
<li><a href="#program-units">Program Units</a></li>
<li><a href="#data-types">Data Types</a></li>
<li><a href="#structured-types">Structured Types</a></li>
<li><a href="#control-structures">Control Structures</a><ul>
<li><a href="#if">IF</a></li>
<li><a href="#while">WHILE</a></li>
<li><a href="#repeat">REPEAT</a></li>
<li><a href="#for">FOR</a></li>
</ul>
</li>
<li><a href="#built-in-functions">Built-in Functions</a></li>
</ul>
</li>
<li><a href="#modules">Modules</a></li>
<li><a href="#pseudo-module-system">Pseudo Module SYSTEM</a><ul>
<li><a href="#system-arm-specific">SYSTEM: ARM Specific</a></li>
<li><a href="#interrupt-procedures">Interrupt Procedures</a></li>
<li><a href="#special-flags-and-features">Special Flags and Features</a></li>
<li><a href="#type-declarations">Type Declarations</a></li>
<li><a href="#inheritance">Inheritance</a></li>
<li><a href="#run-time-support-for-inheritance">Run-time Support for Inheritance</a></li>
</ul>
</li>
<li><a href="#module-loading-and-commands">Module Loading and Commands</a></li>
<li><a href="#compilation-and-linking">Compilation and Linking</a></li>
<li><a href="#object-file-format">Object File Format</a></li>
<li><a href="#boot-file">Boot-file</a></li>
</ul>
</li>
<li><a href="#minos-kernel">Minos Kernel</a><ul>
<li><a href="#system-start-up">System Start-up</a></li>
<li><a href="#initialisation-of-interrupts">Initialisation of Interrupts</a></li>
<li><a href="#task-scheduling-minos">Task Scheduling (Minos)</a><ul>
<li><a href="#stack-minos">Stack (Minos)</a></li>
<li><a href="#scheduler-minos">Scheduler (Minos)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#serial-communication">Serial Communication</a><ul>
<li><a href="#spi">SPI</a><ul>
<li><a href="#setup">Setup</a></li>
</ul>
</li>
<li><a href="#uart">UART</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#a2-case-study-2">A2 (Case Study 2)</a><ul>
<li><a href="#intel-x86">Intel x86</a><ul>
<li><a href="#resources-x86-compatible-hw">Resources (x86 compatible HW)</a></li>
<li><a href="#interrupt-system-x86">Interrupt System (x86)</a><ul>
<li><a href="#apic">APIC</a></li>
<li><a href="#multiprocessor-specification">MultiProcessor Specification</a></li>
<li><a href="#exception-numbers">Exception Numbers</a></li>
<li><a href="#configuring-apic">Configuring APIC</a></li>
</ul>
</li>
<li><a href="#pci-local-bus">PCI Local Bus</a></li>
</ul>
</li>
<li><a href="#active-oberon-language">Active Oberon Language</a><ul>
<li><a href="#locks-vs-monitors">Locks vs. Monitors</a></li>
<li><a href="#threads-vs-active-objects">Threads vs. Active Objects</a></li>
<li><a href="#object-model-active-oberon">Object Model (Active Oberon)</a></li>
<li><a href="#signal-wait-implementations">Signal-Wait Implementations</a></li>
<li><a href="#monitors-in-active-oberon">Monitors in Active Oberon</a></li>
</ul>
</li>
<li><a href="#active-object-system-a2">Active Object System (A2)</a><ul>
<li><a href="#modular-kernel-structure">Modular Kernel Structure</a></li>
<li><a href="#atomic-operations-hw-support">Atomic Operations (HW Support)</a><ul>
<li><a href="#intel-x86_1">Intel (x86)</a></li>
<li><a href="#arm">ARM</a></li>
<li><a href="#overview">Overview</a></li>
<li><a href="#compare-and-swap-cas">Compare-And-Swap (CAS)</a></li>
<li><a href="#implementation-of-a-spinal-using-cas">Implementation of a spinal using CAS</a></li>
</ul>
</li>
<li><a href="#boot-procedure-a2">Boot Procedure (A2)</a><ul>
<li><a href="#processor-startup">Processor Startup</a></li>
</ul>
</li>
<li><a href="#a2-activities-states">A2 Activities States</a></li>
<li><a href="#run-time-data-structures">Run-Time Data Structures</a></li>
<li><a href="#stack-management">Stack Management</a></li>
<li><a href="#context-switch">Context Switch</a><ul>
<li><a href="#coroutines-synchronous">Coroutines (Synchronous)</a></li>
<li><a href="#asynchronous-context-switch">Asynchronous Context Switch</a></li>
</ul>
</li>
<li><a href="#synchronisation">Synchronisation</a><ul>
<li><a href="#object-locking">Object Locking</a></li>
<li><a href="#priority-inversion">Priority Inversion</a></li>
<li><a href="#priority-inheritance">Priority Inheritance</a></li>
</ul>
</li>
<li><a href="#lock-free-programming">Lock-Free Programming</a><ul>
<li><a href="#a2">A2</a><ul>
<li><a href="#goals">Goals</a></li>
<li><a href="#guiding-principles">Guiding Principles</a></li>
<li><a href="#lock-free-kernel">Lock-Free Kernel</a></li>
<li><a href="#memory-model-for-lock-free-active-oberon">Memory Model for Lock-Free Active Oberon</a></li>
</ul>
</li>
<li><a href="#aba-problem">ABA Problem</a><ul>
<li><a href="#hazard-pointers">Hazard Pointers</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#cooperative-multitasking-implicit">Cooperative Multitasking (implicit)</a><ul>
<li><a href="#interrupts">Interrupts</a></li>
<li><a href="#queue-data-structures">Queue Data Structures</a><ul>
<li><a href="#scheduling-activities">Scheduling (Activities)</a></li>
<li><a href="#task-switch-finalizer">Task Switch Finalizer</a></li>
</ul>
</li>
<li><a href="#stack-management_1">Stack Management</a><ul>
<li><a href="#interrupts_1">Interrupts</a></li>
<li><a href="#lock-free-memory-management">Lock-Free Memory Management</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#portability">Portability</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#oberon-risc-case-study-3">Oberon RISC (Case Study 3)</a></li>
<li><a href="#active-cells-case-study-4">Active Cells (Case Study 4)</a><ul>
<li><a href="#tiny-register-machine-trm">Tiny Register Machine (TRM)</a></li>
<li><a href="#active-cells">Active Cells</a></li>
<li><a href="#programming-language-vs-hdl">Programming Language vs. HDL</a><ul>
<li><a href="#programming-language">Programming Language</a></li>
<li><a href="#hardware-description-language">Hardware Description Language</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<h1 id="minos-on-raspberry-pi-2-case-study-1">Minos on Raspberry PI 2 (Case Study 1)</h1>
<h2 id="arm-a7">ARM A7</h2>
<p>The ARM <em>Architecture</em> is not the same thing as the ARM <em>Processor-Families</em></p>
<h3 id="documentation">Documentation</h3>
<p>There is a lot of good documentation for the ARM processors available. But it's difficult to
find the right documents.</p>
<table class="table table-hover table-striped">
<thead>
<tr>
<th>Document</th>
<th>Main Content</th>
</tr>
</thead>
<tbody>
<tr>
<td>ARM Architecture Reference Manual (ARMv7-AR, ARM ARM)</td>
<td>Possibility of implementing the processor. For compilers and tools. Partly used for system programming</td>
</tr>
<tr>
<td>ARM Technical System Reference (ARM Cortex-A7MPCore Family)</td>
<td>Particular Implementation. Some redundant information to ARM ARM.</td>
</tr>
<tr>
<td>System On Chip Implementation Manual (BCM 2835)</td>
<td>How the core is embedded on the chip with peripherals. Address map. Peripheral information.</td>
</tr>
</tbody>
</table>
<h3 id="6-kinds-of-instructions">6 Kinds Of Instructions</h3>
<ol>
<li>Data Processing</li>
<li>Branch Instructions</li>
<li>Status Register Transfer</li>
<li>Load and Store (RISC)</li>
<li>Generic Coprocessor Instructions</li>
<li>Exception Generation</li>
</ol>
<ul>
<li>Load-/Store: No memory operands (not as x86)<ul>
<li>Load: from memory to register</li>
<li>Store: from register to memory</li>
</ul>
</li>
<li>Multiple-Data-Transfer commands (<code>stmdb sp!,{fp,lr}</code>, <code>!</code>: Write-Back)</li>
<li>Link Register: <code>bl</code>: Branch-and-Link (stores PC in link register)</li>
<li>PC-Relative Addressing: Loading large constants (that have no space in instruction encoding) form code</li>
</ul>
<h3 id="execution-modes">Execution Modes</h3>
<ul>
<li>7 Modes</li>
<li>for exception handling</li>
<li>Processor starts in supervisor mode</li>
<li>Registers are shadowed (banked) in different modes</li>
<li>System Mode: privileged but same registers as user mode</li>
</ul>
<table class="table table-hover table-striped">
<thead>
<tr>
<th>Privilege Level</th>
<th>Mode</th>
<th>Description/Cause</th>
<th>Exception/Normal Execution</th>
</tr>
</thead>
<tbody>
<tr>
<td>privileged</td>
<td>Supervisor</td>
<td>Reset / Software Interrupt</td>
<td>exception</td>
</tr>
<tr>
<td>privileged</td>
<td>FIQ</td>
<td>Fast Interrupt</td>
<td>exception</td>
</tr>
<tr>
<td>privileged</td>
<td>IRQ</td>
<td>Normal Interrupt</td>
<td>exception</td>
</tr>
<tr>
<td>privileged</td>
<td>Abort</td>
<td>Memory Access Violation</td>
<td>exception</td>
</tr>
<tr>
<td>privileged</td>
<td>Undef</td>
<td>Undefined Instruction</td>
<td>exception</td>
</tr>
<tr>
<td>privileged</td>
<td>System</td>
<td>Privileged Mode with same registers as in User Mode</td>
<td>normal execution</td>
</tr>
<tr>
<td><strong>un</strong>privileged</td>
<td>User</td>
<td>Regular Application Mode</td>
<td>normal execution</td>
</tr>
</tbody>
</table>
<h3 id="special-registers">Special Registers</h3>
<ul>
<li>R15: PC (Program Counter)</li>
<li>R14: LR (Return address for procedure)</li>
<li>R13: SP ('top' of the stack)</li>
<li>R12: FP (by convention, stored SP before procedure call)</li>
<li>CPSR (Processor Status Register)<ul>
<li>Mode Bits</li>
<li>IRQ Disable</li>
<li>Condition Flags</li>
<li>...</li>
</ul>
</li>
</ul>
<h3 id="typical-procedure-call">Typical Procedure Call</h3>
<ul>
<li>
<p>Caller</p>
<ul>
<li>Pushes params</li>
<li><code>BL #address</code>: Stores PC of next instruction in LR</li>
</ul>
</li>
<li>
<p>Callee</p>
<ul>
<li>Save LR and FP on stack: <code>stmdb sp!, {fp, lr}</code></li>
<li>Set new FP: <code>mov fp, sp</code></li>
<li>Execute procedure content</li>
<li>Reset stack pointer: <code>mov lr, sp</code></li>
<li>Restore FP and jump back to caller address: <code>ldmia sp!, {fp, pc}</code></li>
</ul>
</li>
<li>
<p>Caller</p>
<ul>
<li>Clean up parameters from stack: <code>add sp,sp, #n</code></li>
</ul>
</li>
</ul>
<h3 id="exceptions">Exceptions</h3>
<ul>
<li>Interrupt: asynchronous event triggered by a device signal</li>
<li>Trap / Syscall: intentional exception</li>
<li>Fault: error condition that a handler might be able to correct</li>
<li>Abort: error condition that cannot be corrected</li>
</ul>
<h3 id="misc">Misc</h3>
<ul>
<li>FIRQ is about having more stacked registers</li>
<li>Return Link type: Different sizes because of pipe-line</li>
</ul>
<h2 id="raspberry-pi-2">Raspberry PI 2</h2>
<ul>
<li>Quad Core</li>
<li>1 GB RAM</li>
<li>40 Pin GPIO, ...</li>
<li>UART, SPI, USB, Ethernet, ...</li>
<li>Powered from MicroUSB</li>
</ul>
<h3 id="booting">Booting</h3>
<ul>
<li>Kernel is copied to address: <code>0x8000h</code> and branches there (instead to <code>0x00</code>)</li>
<li>MMU is disabled</li>
<li>Only one core is running</li>
</ul>
<h3 id="mmu">MMU</h3>
<ul>
<li>Memory translation is complicated due to two different MMU's</li>
<li>ARM's memory mapped registers start from <code>0x3f000000</code>, opposed to <code>0x7e000000</code> in BMC manual</li>
</ul>
<h3 id="gpio">GPIO</h3>
<ul>
<li>Some GPIO Registers need Read-Modify-Write (i.e GPFSELn)</li>
<li>Other Registers support setting or clearing single bits:<ul>
<li>i.e Set GPIO Pin: GPSETn</li>
<li>i.e Clear GPIO Pin: GPCLRn</li>
</ul>
</li>
</ul>
<h2 id="minos-and-oberon">Minos and Oberon</h2>
<h3 id="history-of-oberon">History of Oberon</h3>
<p><img alt="Oberon Language and OS Family" class="img-responsive" src="/images/syscon_oberon_history.png"/></p>
<h3 id="oberon">Oberon</h3>
<ul>
<li>Modules can be compiled separately</li>
<li>Strongly typed<ul>
<li>Static type checking at compile time</li>
<li>Run-time support for type guards / tests</li>
</ul>
</li>
<li>High Level (minimal Assembler code)</li>
<li>Special low level functions in <code>SYSTEM</code> pseudo module (compiler directives)</li>
</ul>
<h4 id="oberon07">Oberon07</h4>
<ul>
<li>Minimal</li>
<li>No type <code>OBJECT*</code> no member functions (methods)</li>
</ul>
<h4 id="language-constructs">Language Constructs</h4>
<h5 id="program-units">Program Units</h5>
<ul>
<li><code>MODULE</code></li>
<li><code>PROCEDURE</code><ul>
<li>Value, <code>VAR</code> (in-out) and <code>CONST</code> parameters</li>
</ul>
</li>
</ul>
<h5 id="data-types">Data Types</h5>
<ul>
<li><code>BOOLEAN</code>, <code>CHAR</code>, <code>SHORTINT</code>, <code>INTEGER</code>, <code>LONGINT</code>, <code>HUGEINT</code>, <code>REAL</code>, <code>LONGREAL</code>, <code>SET</code>, <code>ADDRESS</code>, <code>SIZE</code></li>
</ul>
<h5 id="structured-types">Structured Types</h5>
<ul>
<li><code>ARRAY</code>, <code>POINTER TO ARRAY</code></li>
<li><code>RECORD</code> (with type extension), <code>POINTER TO RECORD</code></li>
</ul>
<h5 id="control-structures">Control Structures</h5>
<h6 id="if"><code>IF</code></h6>
<div class="highlight"><pre><span class="kr">IF</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span> <span class="kr">THEN</span>
    <span class="cm">(* statement sequence *)</span>
<span class="kr">END</span><span class="p">;</span>
</pre></div>
<h6 id="while"><code>WHILE</code></h6>
<div class="highlight"><pre><span class="kr">WHILE</span> <span class="n">x</span><span class="o">&lt;</span><span class="n">n</span> <span class="kr">DO</span>
    <span class="cm">(* statement sequence *)</span>
<span class="kr">END</span><span class="p">;</span>
</pre></div>
<h6 id="repeat"><code>REPEAT</code></h6>
<div class="highlight"><pre><span class="kr">REPEAT</span>
    <span class="cm">(* statement sequence *)</span>
<span class="kr">UNTIL</span> <span class="n">x</span><span class="o">=</span><span class="n">n</span><span class="p">;</span>
</pre></div>
<h6 id="for"><code>FOR</code></h6>
<div class="highlight"><pre><span class="kr">FOR</span> <span class="n">i</span> <span class="o">:=</span> <span class="mi">0</span> <span class="kr">TO</span> <span class="mi">100</span> <span class="kr">DO</span>
    <span class="cm">(* statement seq *)</span>
<span class="kr">END</span><span class="p">;</span>
</pre></div>
<h5 id="built-in-functions">Built-in Functions</h5>
<p>Increment and decrement</p>
<div class="highlight"><pre><span class="k-Pervasive">INC</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="k-Pervasive">DEC</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="k-Pervasive">INC</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>
<span class="k-Pervasive">DEC</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>
</pre></div>
<p>Sets</p>
<div class="highlight"><pre><span class="k-Pervasive">INCL</span><span class="p">(</span><span class="n">set</span><span class="p">,</span> <span class="n">element</span><span class="p">);</span>
<span class="k-Pervasive">EXCL</span><span class="p">(</span><span class="n">set</span><span class="p">,</span> <span class="n">element</span><span class="p">);</span>
</pre></div>
<p>Assert and Halt</p>
<div class="highlight"><pre><span class="n">ASSERT</span><span class="p">(</span><span class="n">b</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">);</span>
<span class="k-Pervasive">HALT</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
</pre></div>
<p>Allocation</p>
<div class="highlight"><pre><span class="k-Pervasive">NEW</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">..</span><span class="p">.);</span>
</pre></div>
<p>Shifts</p>
<div class="highlight"><pre><span class="n">ASH</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">);</span>
<span class="n">LSH</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">);</span>
<span class="n">ROT</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">);</span>
</pre></div>
<p>Conversion</p>
<div class="highlight"><pre><span class="n">SHORT</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="n">LONG</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="k-Pervasive">ORD</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
<span class="k-Pervasive">CHR</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="n">ENTIER</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</pre></div>
<p>Arrays</p>
<div class="highlight"><pre><span class="n">LEN</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="n">LEN</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">);</span>
<span class="n">DIM</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
</pre></div>
<p>Misc</p>
<div class="highlight"><pre><span class="k-Pervasive">ABS</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="k-Pervasive">MAX</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
<span class="k-Pervasive">MIN</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
<span class="k-Pervasive">ODD</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="k-Pervasive">CAP</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</pre></div>
<p>Addresses and Sizes</p>
<div class="highlight"><pre><span class="n">ADDRESS</span> <span class="kr">OF</span> <span class="n">x</span><span class="p">;</span>
<span class="n">ADDRESSOF</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="k-Pervasive">SIZE</span> <span class="kr">OF</span> <span class="n">t</span><span class="p">;</span>
<span class="n">SIZEOF</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
</pre></div>
<h4 id="modules">Modules</h4>
<ul>
<li><code>PROCEDURE Write* ...</code>: Exported (<code>*</code>)</li>
<li>Module body is executed first and only once</li>
<li>Module can be loaded only once (keeps state, can be unloaded)</li>
<li>Procedures without params can be executed as commands</li>
<li>Comments: <code>(* ... *)</code></li>
<li>Special Type: <code>SET</code> contains ints up to CPU bit size: i.e 1..32 (<code>{12, 5}</code>)</li>
<li><code>SYSTEM</code> Pseudo Module<ul>
<li>Unsafe!</li>
<li>Memory Access</li>
<li><code>SYSTEM.BYTE</code>: raw binary data (with length and bound checks)</li>
<li>Type Casts: can be unsafe!</li>
</ul>
</li>
<li>Procedure Flags:<ul>
<li><code>INTERRUPT</code>: for ISR's</li>
<li><code>PCOFFSET=k</code>: offset for returning from ISR</li>
</ul>
</li>
<li>Unsafe Pointer: can write to memory address</li>
</ul>
<h4 id="pseudo-module-system">Pseudo Module <code>SYSTEM</code></h4>
<p>Direct Memory Access Functions</p>
<div class="highlight"><pre><span class="n">SYSTEM</span><span class="p">.</span><span class="n">PUT</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
<span class="n">SYSTEM</span><span class="p">.</span><span class="n">GET</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
<span class="n">SYSTEM</span><span class="p">.</span><span class="n">PUT8</span><span class="p">|</span><span class="mi">16</span><span class="p">|</span><span class="mi">32</span><span class="p">|</span><span class="mi">64</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
<span class="n">x</span> <span class="o">:=</span> <span class="n">SYSTEM</span><span class="p">.</span><span class="n">GET8</span><span class="p">|</span><span class="mi">16</span><span class="p">|</span><span class="mi">32</span><span class="p">|</span><span class="mi">64</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="n">SYSTEM</span><span class="p">.</span><span class="n">MOVE</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
</pre></div>
<p>Data Type</p>
<div class="highlight"><pre><span class="n">SYSTEM</span><span class="p">.</span><span class="n">BYTE</span>
</pre></div>
<p>Type Cast</p>
<div class="highlight"><pre><span class="n">b</span> <span class="o">:=</span> <span class="n">SYSTEM</span><span class="p">.</span><span class="k-Pervasive">VAL</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
</pre></div>
<p>Example of Low-Level access</p>
<div class="highlight"><pre><span class="kr">IMPORT</span> <span class="n">SYSTEM</span><span class="p">;</span>

<span class="kr">PROCEDURE</span> <span class="n">LetThereBeLight</span><span class="p">;</span>
<span class="kr">CONST</span> <span class="n">GPSET0</span> <span class="o">=</span> <span class="mh">03F20001C</span><span class="n">H</span><span class="p">;</span>
<span class="kr">BEGIN</span>
    <span class="n">SYSTEM</span><span class="p">.</span><span class="n">PUT</span><span class="p">(</span><span class="n">GPSET0</span><span class="p">,</span> <span class="p">{</span><span class="mi">21</span><span class="p">});</span>
<span class="kr">END</span> <span class="n">LetThereBeLight</span><span class="p">;</span>
</pre></div>
<h5 id="system-arm-specific"><code>SYSTEM</code>: ARM Specific</h5>
<p>Register Access</p>
<div class="highlight"><pre><span class="n">SYSTEM</span><span class="p">.</span><span class="n">SP</span><span class="p">();</span>
<span class="n">SYSTEM</span><span class="p">.</span><span class="n">FP</span><span class="p">();</span>
<span class="n">SYSTEM</span><span class="p">.</span><span class="n">LNK</span><span class="p">();</span>

<span class="n">SYSTEM</span><span class="p">.</span><span class="n">SETSP</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="n">SYSTEM</span><span class="p">.</span><span class="n">SETFP</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="n">SYSTEM</span><span class="p">.</span><span class="n">SETLR</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>

<span class="n">SYSTEM</span><span class="p">.</span><span class="n">LDPSR</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">x</span><span class="p">);</span>
<span class="n">SYSTEM</span><span class="p">.</span><span class="n">STPSR</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">x</span><span class="p">);</span>
<span class="n">SYSTEM</span><span class="p">.</span><span class="n">LDCPR</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">);</span>
<span class="n">SYSTEM</span><span class="p">.</span><span class="n">STCPR</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">);</span>
<span class="n">SYSTEM</span><span class="p">.</span><span class="n">FLUSH</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
</pre></div>
<p>Floating Point</p>
<div class="highlight"><pre><span class="n">SYSTEM</span><span class="p">.</span><span class="n">NULL</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="n">SYSTEM</span><span class="p">.</span><span class="n">MULD</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">);</span>
</pre></div>
<h5 id="interrupt-procedures">Interrupt Procedures</h5>
<div class="highlight"><pre><span class="kr">PROCEDURE</span> <span class="n">Handler</span> <span class="p">{</span><span class="n">INTERRUPT</span><span class="p">,</span> <span class="n">PCOFFSET</span><span class="o">=</span><span class="n">k</span><span class="p">};</span>
<span class="kr">BEGIN</span> <span class="cm">(* k is the offset to the next instruction</span>
<span class="cm">         cf. table of exceptions *)</span>
<span class="kr">END</span> <span class="n">Handler</span><span class="p">;</span>
</pre></div>
<h5 id="special-flags-and-features">Special Flags and Features</h5>
<p>Procedure without activation frame</p>
<div class="highlight"><pre><span class="kr">PROCEDURE</span> <span class="p">{</span><span class="n">NOTAG</span><span class="p">}</span>
</pre></div>
<p>Procedure that is linked to the beginning of a kernel</p>
<div class="highlight"><pre><span class="kr">PROCEDURE</span> <span class="p">{</span><span class="n">INITIAL</span><span class="p">}</span>
</pre></div>
<p>Inline assembler block</p>
<div class="highlight"><pre><span class="n">CODE</span> <span class="o">..</span><span class="p">.</span> <span class="kr">END</span>
</pre></div>
<p>Alignment of a symbol (i. e variable)</p>
<div class="highlight"><pre><span class="n">symbol</span> <span class="p">{</span><span class="n">ALIGNED</span><span class="p">(</span><span class="mi">32</span><span class="p">)}</span>
</pre></div>
<p>Pinning of a symbol</p>
<div class="highlight"><pre><span class="n">symbol</span> <span class="p">{</span><span class="n">FIXED</span><span class="p">(</span><span class="mi">0</span><span class="n">x8000</span><span class="p">))</span>
</pre></div>
<p>Unsafe pointer that is assignment compatible with type <code>ADDRESS</code></p>
<div class="highlight"><pre><span class="kr">POINTER</span> <span class="p">{</span><span class="n">UNSAFE</span><span class="p">}</span> <span class="kr">TO</span> <span class="o">..</span><span class="p">.</span>
</pre></div>
<p>Symbol that is invisible to a Garbage Collector</p>
<div class="highlight"><pre><span class="n">symbol</span> <span class="p">{</span><span class="n">UNTRACED</span><span class="p">}</span>
</pre></div>
<h5 id="type-declarations">Type Declarations</h5>
<div class="highlight"><pre><span class="kr">TYPE</span>

<span class="n">Device</span><span class="o">*</span> <span class="o">=</span> <span class="kr">POINTER</span> <span class="kr">TO</span> <span class="n">DeviceDesc</span><span class="p">;</span>  <span class="cm">(* Pointer to record (reference type)*)</span>
<span class="n">DeviceDesc</span><span class="o">*</span> <span class="o">=</span> <span class="kr">RECORD</span>              <span class="cm">(* Record: Value type *)</span>
    <span class="n">id</span><span class="o">*</span><span class="p">:</span> <span class="k-Pervasive">INTEGER</span><span class="p">;</span>
    <span class="n">Open</span><span class="o">*</span><span class="p">:</span> <span class="kr">PROCEDURE</span><span class="p">(</span><span class="n">dev</span><span class="p">:</span> <span class="n">Device</span><span class="p">);</span>
    <span class="n">Close</span><span class="o">*</span><span class="p">:</span> <span class="kr">PROCEDURE</span><span class="p">(</span><span class="n">dev</span><span class="p">:</span> <span class="n">Device</span><span class="p">);</span>
    <span class="n">next</span><span class="o">*</span><span class="p">:</span> <span class="n">Device</span><span class="p">;</span>
<span class="kr">END</span><span class="p">;</span>

<span class="cm">(* Procedure type with signature *)</span>
<span class="n">TrapHandler</span><span class="o">*</span> <span class="o">=</span> <span class="kr">PROCEDURE</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">fp</span><span class="p">:</span> <span class="k-Pervasive">INTEGER</span><span class="p">;</span> <span class="kr">VAR</span> <span class="n">res</span><span class="p">:</span> <span class="k-Pervasive">INTEGER</span><span class="p">);</span>

<span class="n">NumberType</span><span class="o">*</span> <span class="o">=</span> <span class="k-Pervasive">REAL</span><span class="p">;</span> <span class="cm">(* Type alias *)</span>

<span class="n">DeviceName</span><span class="o">*</span> <span class="kr">ARRAY</span> <span class="n">DeviceNameLength</span> <span class="kr">OF</span> <span class="k-Pervasive">CHAR</span><span class="p">;</span> <span class="cm">(* Array Type *)</span>

<span class="n">Data</span><span class="o">*</span> <span class="kr">POINTER</span> <span class="kr">TO</span> <span class="kr">ARRAY</span> <span class="kr">OF</span> <span class="k-Pervasive">CHAR</span><span class="p">;</span> <span class="cm">(* Dynamic array type *)</span>
</pre></div>
<h5 id="inheritance">Inheritance</h5>
<div class="highlight"><pre><span class="n">Task</span><span class="o">*</span> <span class="o">=</span> <span class="kr">POINTER</span> <span class="kr">TO</span> <span class="n">TaskDesc</span><span class="p">;</span>
<span class="n">TaskDesc</span><span class="o">*</span> <span class="o">=</span> <span class="kr">RECORD</span>
    <span class="n">task</span> <span class="n">task</span> <span class="n">task</span>
    <span class="n">task</span> <span class="n">task</span>
    <span class="n">proc</span><span class="p">:</span><span class="kr">PROCEDURE</span><span class="p">(</span><span class="n">me</span><span class="p">:</span><span class="n">Task</span><span class="p">);</span> <span class="cm">(* This procedure is executed in the task *)</span>
    <span class="n">next</span><span class="p">:</span> <span class="n">Task</span><span class="p">;</span>              <span class="cm">(* The next task in the list of tasks *)</span>
<span class="kr">END</span><span class="p">;</span>

<span class="n">PeriodicTask</span><span class="o">*</span> <span class="o">=</span> <span class="kr">POINTER</span> <span class="kr">TO</span> <span class="n">PeriodicTaskDesc</span><span class="p">;</span>
<span class="n">PeriodicTaskDesc</span><span class="o">*</span> <span class="o">=</span> <span class="kr">RECORD</span> <span class="p">(</span><span class="n">TaskDesc</span><span class="p">)</span> <span class="cm">(* inherits TaskDesc *)</span>
    <span class="n">priority</span><span class="p">:</span> <span class="k-Pervasive">LONGINT</span><span class="p">;</span> <span class="cm">(* The priority determines the execution order *)</span>
    <span class="n">interval</span><span class="p">:</span> <span class="k-Pervasive">LONGINT</span><span class="p">;</span> <span class="cm">(* The task is executed every "interval" msecs *)</span>
<span class="kr">END</span><span class="p">;</span>
</pre></div>
<p>Type Test</p>
<div class="highlight"><pre><span class="kr">IF</span> <span class="n">task</span> <span class="n">IS</span> <span class="n">PeriodicTask</span> <span class="kr">THEN</span> <span class="o">..</span><span class="p">.</span> <span class="kr">END</span><span class="p">;</span>
</pre></div>
<p>Type Guard (cast)</p>
<div class="highlight"><pre><span class="kr">IF</span> <span class="n">task</span><span class="p">(</span><span class="n">PeriodicTask</span><span class="p">).</span><span class="n">priority</span> <span class="o">=</span> <span class="mi">1</span> <span class="kr">THEN</span> <span class="o">..</span><span class="p">.</span> <span class="kr">END</span><span class="p">;</span>
</pre></div>
<p>Type Test and Guard</p>
<div class="highlight"><pre><span class="kr">WITH</span> <span class="n">task</span><span class="p">:</span> <span class="n">PeriodicTask</span> <span class="kr">DO</span> <span class="o">..</span><span class="p">.</span> <span class="kr">END</span><span class="p">;</span>
</pre></div>
<h5 id="run-time-support-for-inheritance">Run-time Support for Inheritance</h5>
<ul>
<li>RTTI is supported</li>
<li>Each type gets an unique type descriptor (<code>LONGINT</code>)</li>
<li>The variables contain an array of up to 3 tags</li>
<li>The tags point to the type descriptors</li>
<li>Inheritance level is restricted to 3</li>
</ul>
<h4 id="module-loading-and-commands">Module Loading and Commands</h4>
<ul>
<li>Modules are loaded on demand (first use)</li>
<li>Statically linked modules are loaded at boot-time</li>
<li>Exported Procedures without parameters act as commands</li>
<li>Modification of modules needs reloading</li>
<li>Unloading possible, if no other loaded module (static or dynamic) depends on it</li>
<li>If a command of a not loaded module is executed the module is loaded first</li>
</ul>
<h4 id="compilation-and-linking">Compilation and Linking</h4>
<ul>
<li>A module (.mod) is compiled to an executable file / object file (.arm) and a symbol file (.smb)</li>
<li>The executable file contains a fingerprint</li>
<li>The linker adds fingerprint to dependent object files (fix-up)</li>
</ul>
<h4 id="object-file-format">Object File Format</h4>
<p>Compiler flags:</p>
<div class="highlight"><pre>Compiler.Compile -b=ARM --objectFile=Minos
</pre></div>
<ul>
<li>The object file is very compact</li>
<li>Key: Fingerprint</li>
<li>Fix-ups → Fix-up-root (relocation table) linked list to fix-ups</li>
<li>Downsides:<ul>
<li>Module file is limited</li>
<li>Not very maintainable</li>
</ul>
</li>
</ul>
<p><img alt="Minos Object Files" class="img-responsive" src="/images/syscon_minos_object_file.png"/></p>
<p>This image is taken from the lecture slides provided by Felix Friedrich</p>
<h4 id="boot-file">Boot-file</h4>
<ul>
<li>Linked Modules of Kernel files (hierarchy)</li>
<li>Predefined loading address and entry point (0x8000 for RPI2)</li>
</ul>
<p>Boot-Linking command in host system</p>
<div class="highlight"><pre>MinosLinker.Link minimalinit.img 108000H kernel.img OFSRamVolumes SerialLog Minos  ~
</pre></div>
<p>Image header: <code>minimalinit.img</code>
Start address: <code>108000H</code>
Image file name: <code>kernel.img</code>
Object file names (compiled): <code>OFSRamVolumes SerialLog Minos  ~</code></p>
<!-- Beginning of Slides Week 3 -->
<h3 id="minos-kernel">Minos Kernel</h3>
<h4 id="system-start-up">System Start-up</h4>
<ul>
<li>
<p>Firmware (RPI2, GPU)</p>
<ol>
<li>Initialise HW</li>
<li>Copy boot image to RAM</li>
<li>Jump to boot image (initializer)</li>
</ol>
</li>
<li>
<p>Initializer</p>
<ol>
<li>Set <em>stack registers</em> for all processor modes</li>
<li>Setup <em>free heap</em> and <em>module</em> list</li>
<li>Initialise <em>MMU</em> and <em>page table</em></li>
<li>Setup <em>interrupt handler</em> and <em>vectors</em></li>
<li>Start <em>timer</em> and <em>enable interrupts</em></li>
<li>Initializer UARTs, RAM disks, ...</li>
<li>Enter scheduling loop on OS</li>
</ol>
</li>
</ul>
<p>The Minos Kernel is modular:</p>
<ul>
<li>Minos: Command interpreter and scheduler</li>
<li>Modules: Module loader, dynamic linker</li>
<li>File System: RamVolumes, OFS, ...</li>
<li>Kernel: Memory management, device drivers</li>
<li>I/O: Kernel logging, ...</li>
<li>Run-time: Memory allocation (heaps), FPU emulation, ...</li>
</ul>
<!-- Slides Week 3 09-29 p. 84 (6) -->
<p>...</p>
<!-- Slides and Notes Week 4 -->
<h4 id="initialisation-of-interrupts">Initialisation of Interrupts</h4>
<ol>
<li>Set handlers of IRQ's<ul>
<li>Write handlers for needed interrupts</li>
<li>Put jumps to handlers into interrupt table</li>
</ul>
</li>
<li>Enable IRQ's</li>
</ol>
<p>Usually Interrupts need to be configured in 3 parts:</p>
<ul>
<li>CPU (enable, masking...)</li>
<li>Interrupt Controller</li>
<li>Device</li>
</ul>
<p>The RPI2 has 3 memory-mapped IRQ registers (32-bit):</p>
<ul>
<li><em>Pending Bits</em> indicate which interrupts are pending</li>
<li>Need to be checked in the <em>IRQ Trap Handler</em> (1st level handler)</li>
<li>Call <em>IRQ Handler</em> (2nd level) depending on pending bits</li>
</ul>
<h4 id="task-scheduling-minos">Task Scheduling (Minos)</h4>
<p>3 Task types:</p>
<ul>
<li>High Priority (every 5 ms)</li>
<li>Low Priority (every 20 ms)</li>
<li>Background tasks</li>
</ul>
<p>Preemption:</p>
<ul>
<li>High priority tasks preempt low priority and background tasks</li>
<li>Low priority tasks preempt only low priority tasks</li>
<li>Background tasks don't preempt any tasks</li>
</ul>
<p>Task Descriptors for</p>
<ul>
<li>Synchronous (periodic) tasks</li>
<li>Asynchronous (background) tasks</li>
</ul>
<h5 id="stack-minos">Stack (Minos)</h5>
<ul>
<li>One stack for all processes</li>
<li>Every task needs to run to completion</li>
<li>Preemption is possible<ul>
<li>Preempting task needs to be completed before returning</li>
</ul>
</li>
</ul>
<h5 id="scheduler-minos">Scheduler (Minos)</h5>
<p>Recursive interrupt procedure</p>
<ul>
<li>Prolog: Interrupts masked</li>
<li>Scheduling: Interrupts allowed</li>
<li>Epilogue: Interrupts masked</li>
</ul>
<p>Scheduler procedure must be <em>reentrant</em></p>
<ul>
<li>Register values on stack</li>
<li>Private variables</li>
</ul>
<p>Assumptions for scheduler</p>
<ul>
<li>Linked list stores tasks sorted by period and priority</li>
<li>Tasks run to completion within given period</li>
</ul>
<!-- End of Week 4 -->
<!-- Beginning of Week 5 -->
<h2 id="serial-communication">Serial Communication</h2>
<ul>
<li>Directionally<ul>
<li>Simplex</li>
<li>Half duplex</li>
<li>Full duplex</li>
</ul>
</li>
<li>Synchrony<ul>
<li>Synchronous</li>
<li>Asynchronous</li>
</ul>
</li>
</ul>
<p>Examples:</p>
<ul>
<li>RS-232</li>
<li>RS-458</li>
<li>SPI (SSP, Microwire)</li>
<li>I<span class="math">\(^2\)</span>C</li>
<li>1-Wire</li>
<li>USB</li>
</ul>
<h3 id="spi">SPI</h3>
<ul>
<li>Very simple</li>
<li>4 Wires:<ul>
<li>SCLK: Serial bit-rate Clock</li>
<li>MOSI: Master data Output, Slave data Input</li>
<li>MISO: Master data Input, Slave data Output</li>
<li>SS: Slave Select</li>
</ul>
</li>
<li>Configurations:<ul>
<li>Single slave mode: 1 Master, 1 Slave</li>
<li>multiple slave mode: 1 Master, N Slaves</li>
</ul>
</li>
<li>Synchronous bidirectional data transfer</li>
<li>Data transfer initiated by master</li>
<li>Bandwidth some KBits/s up to several MBits/s</li>
<li>Simple implementation in software possible (bit-banging)</li>
<li>Master and Slave have shift registers for data (in and output)<ul>
<li>During communication data 'circles around' between the two shift registers</li>
</ul>
</li>
</ul>
<p>Communication</p>
<ol>
<li>Master pulls SS to low</li>
<li>Master pushed data out of shift register</li>
<li>Slave pushes data out of shift register at the same time</li>
<li>Sampling happens at SCLK</li>
<li>To finish communication master stops SCLK</li>
</ol>
<ul>
<li>No acknowledgment mechanism</li>
<li>No device interrupts</li>
</ul>
<h4 id="setup">Setup</h4>
<ul>
<li>Polarity (SCLK):<ul>
<li>0: Sampling happens on rising SCLK edge</li>
<li>1: Sampling happens on falling SCLK edge</li>
</ul>
</li>
<li>Phase (SCLK):<ul>
<li>0: Rising SCLK edge in the middle of data</li>
<li>1: Rising SCLK edge on beginning of data</li>
</ul>
</li>
</ul>
<h3 id="uart">UART</h3>
<ul>
<li>Serial transmission (least significant bit first)</li>
<li>Configurable<ul>
<li>Number of data bits: 5, 6, 7, 8</li>
<li>Parity: odd, even, none</li>
<li>Stop-bits: 1, 1.5, 2</li>
<li>Transfer rate (bits per second): 75, 110, 300, ..., 115200</li>
<li>Flow control exists in some implementations</li>
</ul>
</li>
</ul>
<!-- End of Week 5 -->
<!-- Beginning of Week 6 -->
<h1 id="a2-case-study-2">A2 (Case Study 2)</h1>
<h2 id="intel-x86">Intel x86</h2>
<ul>
<li>Shared Memory (for all processors)</li>
<li>Symmetrical Multiple Processors (SMP)</li>
</ul>
<h3 id="resources-x86-compatible-hw">Resources (x86 compatible HW)</h3>
<p><a href="http://wiki.osdev.org">osdev.org</a></p>
<ul>
<li>SDM: Intel® 64 and IA-32 Architectures Software Developer’s Manual (4000 p., 3 volumes)<ol>
<li>Architecture</li>
<li>Instruction Set Reference</li>
<li>System Programming Guide</li>
</ol>
</li>
<li>MP Spec: Intel Multiprocessor Specification, version 1.4 (100 p.)</li>
<li>ACPI Spec: Advanced Configuration and Power Interface Specification (1000 p.)</li>
<li>PCI Spec: PCI Local Bus Specification Rev. 2.2 (322 p.)</li>
</ul>
<h3 id="interrupt-system-x86">Interrupt System (x86)</h3>
<ul>
<li>External IRQ's (asynchronous)<ul>
<li>I/O Devices</li>
<li>Timer</li>
<li>Inter-processor interrupts</li>
</ul>
</li>
<li>Software IRQ's (synchronous)<ul>
<li>Traps/Syscall: special instructions</li>
</ul>
</li>
<li>Processor exceptions (synchronous)<ul>
<li>Faults (restartable): i.e page fault</li>
<li>Aborts (Fatal): i.e machine check</li>
</ul>
</li>
</ul>
<h4 id="apic">APIC</h4>
<ul>
<li>Each CPU has local APIC (local interrupts)</li>
<li>
<p>I/O APIC for all CPU's (external interrupts)</p>
</li>
<li>
<p>Messages to processors</p>
<ul>
<li>Start Processor: Activation and Initialisation of individual processors</li>
<li>Halt Processor: Deactivation of individual processors</li>
<li>Halt Process, schedule new process: Interrupt in order to transfer control to scheduler</li>
</ul>
</li>
<li>Local timers<ul>
<li>Periodical interrupts</li>
</ul>
</li>
</ul>
<h4 id="multiprocessor-specification">MultiProcessor Specification</h4>
<ul>
<li>Standard by Intel (MP Spec 1.4)</li>
<li>Hardware Specification<ul>
<li>Memory Map</li>
<li>APIC</li>
<li>Interrupt Modes</li>
</ul>
</li>
<li>MP Configuration Table<ul>
<li>Processor, Bus, I/O APIC</li>
<li>Table address searched via "floating pointer structure"</li>
</ul>
</li>
</ul>
<h4 id="exception-numbers">Exception Numbers</h4>
<table class="table table-hover table-striped">
<thead>
<tr>
<th>Vector #</th>
<th>Description</th>
<th>Source</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>Div error</td>
<td>div / idiv instruction</td>
</tr>
<tr>
<td>1</td>
<td>Debug</td>
<td>Code / data reference</td>
</tr>
<tr>
<td>2</td>
<td>NMI</td>
<td>Non maskable external IRQ</td>
</tr>
<tr>
<td>3</td>
<td>Breakpoint</td>
<td>int 3 instruction</td>
</tr>
<tr>
<td>4 – 19</td>
<td>Other processor exceptions</td>
<td>E.g. page fault etc.</td>
</tr>
<tr>
<td>20-31</td>
<td>reserved</td>
<td></td>
</tr>
<tr>
<td>32-255</td>
<td>Maskable Interrupts</td>
<td>External Interrupts from <code>INTR</code> pin <code>INT</code> n instruction</td>
</tr>
</tbody>
</table>
<h4 id="configuring-apic">Configuring APIC</h4>
<ul>
<li>Local Vector Table (for local interrupt sources)<ul>
<li>Vector Number, Trigger Mode, Status, Interrupt Vector Mask</li>
<li>Timer Mode (one shot / periodic)</li>
</ul>
</li>
<li>Command Register: Inter Processor Interrupt with<ul>
<li>vector number,</li>
<li>delivery mode: fixed, nmi, init, startup (..)</li>
<li>logical / physical destination (including self and broadcasts with / without self</li>
</ul>
</li>
</ul>
<h3 id="pci-local-bus">PCI Local Bus</h3>
<ul>
<li>Connect Peripheral Components</li>
<li>Standardised Configuration Address Space for all PCI Devices</li>
<li>Interrupt Routing Configuration</li>
</ul>
<p>Access mechanism</p>
<ul>
<li>PCI BIOS: offers functionality such as "find device by classcode". Presence determined by floating data structure in BIOS ROM</li>
<li>Addressable via in / out instructions operating on separate I/O memory address space</li>
<li>PCI Express now Memory Mapped I/O</li>
</ul>
<h2 id="active-oberon-language">Active Oberon Language</h2>
<h3 id="locks-vs-monitors">Locks vs. Monitors</h3>
<ul>
<li>Lock based<ul>
<li>shared data</li>
<li>protected from concurrent access by locks</li>
</ul>
</li>
<li>Monitor based<ul>
<li>locks code (methods) that access shared data</li>
<li>No direct locking of data structures needed</li>
</ul>
</li>
</ul>
<h3 id="threads-vs-active-objects">Threads vs. Active Objects</h3>
<ul>
<li>Threads<ul>
<li>Concurrently running code</li>
</ul>
</li>
<li>Active Objects<ul>
<li>Objects that contain threads</li>
<li>Threads in form of Monitors</li>
</ul>
</li>
</ul>
<h3 id="object-model-active-oberon">Object Model (Active Oberon)</h3>
<ul>
<li>
<p><code>EXCLUSIVE</code>: Protection (mutual exclusion)</p>
<ul>
<li><em>Methods</em> tagged <code>EXCLUSIVE</code> run under <em>mutual exclusion</em></li>
<li>As <code>synchronized</code> in Java</li>
</ul>
</li>
<li>
<p><code>AWAIT</code>: Synchronisation</p>
<ul>
<li>Wait until condition of <code>AWAIT</code> becomes true</li>
</ul>
</li>
<li>
<p><code>ACTIVE</code>: Parallelism</p>
<ul>
<li>Body marked <code>ACTIVE</code> <em>executed as thread</em> for each instance</li>
</ul>
</li>
</ul>
<h3 id="signal-wait-implementations">Signal-Wait Implementations</h3>
<ul>
<li>Signal-and-Continue<ul>
<li>Java uses this</li>
<li>Race conditions can occur</li>
</ul>
</li>
<li>Signal-and-Exit<ul>
<li>Active Oberon uses this</li>
<li>Can be achieved in Java by looping on wait condition</li>
</ul>
</li>
</ul>
<p>Active Oberon:</p>
<div class="highlight"><pre><span class="n">Semaphore</span> <span class="o">=</span> <span class="n">OBJECT</span>
    <span class="n">number</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">:</span> <span class="k-Pervasive">LONGINT</span><span class="p">;</span>

    <span class="kr">PROCEDURE</span> <span class="n">enter</span><span class="p">;</span>
    <span class="kr">BEGIN</span><span class="p">{</span><span class="n">EXCLUSIVE</span><span class="p">}</span>
        <span class="n">AWAIT</span> <span class="n">number</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k-Pervasive">DEC</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
    <span class="kr">END</span> <span class="n">enter</span><span class="p">;</span>

    <span class="kr">PROCEDURE</span> <span class="n">exit</span><span class="p">;</span>
    <span class="kr">BEGIN</span><span class="p">{</span><span class="n">EXCLUSIVE</span><span class="p">}</span>
        <span class="k-Pervasive">INC</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
    <span class="kr">END</span> <span class="n">exit</span><span class="p">;</span>

<span class="kr">END</span> <span class="n">Semaphore</span><span class="p">;</span>
</pre></div>
<p>Equivalent Java code:</p>
<div class="highlight"><pre><span class="kd">class</span> <span class="nc">Semaphore</span><span class="o">{</span>
    <span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">enter</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">number</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span>  <span class="c1">// while needed!</span>
            <span class="k">try</span> <span class="o">{</span> <span class="n">wait</span><span class="o">();}</span>
            <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span> <span class="o">};</span>
        <span class="n">number</span><span class="o">--;</span>
    <span class="o">}</span>

    <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">exit</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">number</span><span class="o">++;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">number</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span>
            <span class="n">notify</span><span class="o">();</span>  <span class="cm">/* notifyAll() needed if different threads</span>
<span class="cm">                          evaluate different conditions */</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<h3 id="monitors-in-active-oberon">Monitors in Active Oberon</h3>
<ul>
<li>No <em>notify()</em> (or <em>notifyAll()</em>): Every <code>EXCLUSIVE</code> procedure triggers reevaluation of <code>AWAIT</code> when it returns</li>
<li>Downsides of Monitors:<ul>
<li>Wasting of processor time on looping on 'locks'</li>
<li>Ordering can not be influenced</li>
</ul>
</li>
</ul>
<h2 id="active-object-system-a2">Active Object System (A2)</h2>
<h3 id="modular-kernel-structure">Modular Kernel Structure</h3>
<ul>
<li>Cover: Kernel</li>
<li>Activity Scheduler: Objects</li>
<li>Module Loader (Memory Management): Modules, Heaps</li>
<li>Hardware Abstraction: Machine</li>
</ul>
<h3 id="atomic-operations-hw-support">Atomic Operations (HW Support)</h3>
<p>The supported operations are typically a lot slower than simple read and write operations.</p>
<h4 id="intel-x86_1">Intel (x86)</h4>
<p>From AMD64 Architecture Programmer’s Manual:</p>
<ul>
<li><code>CMPXCHG mem, reg</code></li>
</ul>
<p>"compares the value in Register A with the value in a memory location If the two values are equal,
the instruction copies the value in the second operand to the first operand and sets the ZF flag
in the flag registers to 1. Otherwise it copies the value in the first operand to A register and
clears ZF flag to 0"</p>
<ul>
<li>Lock Prefix</li>
</ul>
<p>"The lock prefix causes certain kinds of memory read-modify- write instructions to occur atomically"</p>
<h4 id="arm">ARM</h4>
<p>From ARM Architecture Reference Manual:</p>
<ul>
<li><code>LDREX &lt;rd&gt;, &lt;rn&gt;</code></li>
</ul>
<p>"Loads a register from memory and if the address has the shared memory attribute, mark the physical
address as exclusive access for the executing processor in a shared monitor"</p>
<ul>
<li><code>STREX &lt;rd&gt;, &lt;rm&gt;, &lt;rn&gt;</code></li>
</ul>
<p>"performs a conditional store to memory. The store only occurs if the executing processor has
exclusive access to the memory addressed"</p>
<h4 id="overview">Overview</h4>
<p>Some typical instructions for atomic operations and implementation examples.</p>
<ul>
<li>Test-And-Set (TAS)<ul>
<li><code>TSL register, flag</code> (Motorola 68000)</li>
</ul>
</li>
<li>Compare-And-Swap (CAS)<ul>
<li><code>LOCK CMPXCHG</code> (Intel x86)</li>
<li><code>CASA</code> (Sparc)</li>
</ul>
</li>
<li>Load Linked / Store Conditional<ul>
<li><code>LDREX</code> / <code>STREX</code> (ARM)</li>
<li><code>LL</code> / <code>SC</code> (MIPS)</li>
</ul>
</li>
</ul>
<blockquote>
<p>These hardware instructions are often much slower than simple read and write.
Caches can't be exploited (direct access to memory)!</p>
</blockquote>
<ul>
<li>Compare-And-Swap is the most universal instruction</li>
</ul>
<h4 id="compare-and-swap-cas">Compare-And-Swap (CAS)</h4>
<p>Atomic operation implemented in processor.</p>
<p>Compares memory location with an value. If it's same a new (given) value is written at the
memory address. Returns the previous value at memory position in any case.</p>
<div class="highlight"><pre><span class="kt">int</span> <span class="n">CAS</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">old</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new</span><span class="p">)</span>
</pre></div>
<ul>
<li>If value <code>old</code> is at memory location of <code>a</code>: safe <code>new</code> at <code>a</code></li>
<li>Return previous value at <code>a</code> in any case</li>
</ul>
<h4 id="implementation-of-a-spinal-using-cas">Implementation of a spinal using CAS</h4>
<div class="highlight"><pre><span class="cm">(* Initialisation *)</span>
<span class="n">Init</span><span class="p">(</span><span class="n">lock</span><span class="p">)</span>
    <span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


<span class="cm">(* Acquire Lock *)</span>
<span class="n">Acquire</span> <span class="p">(</span><span class="n">var</span> <span class="n">lock</span><span class="p">:</span> <span class="n">word</span><span class="p">)</span>
    <span class="n">repeat</span>
        <span class="n">res</span> <span class="o">:=</span> <span class="n">CAS</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">until</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">(* Release Lock *)</span>
<span class="n">Release</span> <span class="p">(</span><span class="n">var</span> <span class="n">lock</span><span class="p">:</span> <span class="n">word</span><span class="p">)</span>
    <span class="n">CAS</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">(* atomicy not needed but visibility/ordering *)</span>
</pre></div>
<!-- End of Notes Week 6 -->
<!-- Beginning of Notes Week 7 -->
<h3 id="boot-procedure-a2">Boot Procedure (A2)</h3>
<ul>
<li>Start BIOS Firmware</li>
<li>Load A2 Boot-file</li>
<li>Initialise modules<ul>
<li>Module <em>Machine</em></li>
<li>Module <em>Heaps</em></li>
<li>...</li>
<li>Module <em>Objects</em><ul>
<li>Setup scheduler and self process</li>
</ul>
</li>
<li>Module <em>Kernel</em><ul>
<li>Start all processors</li>
</ul>
</li>
<li>...</li>
<li>Module Boot-console<ul>
<li>read configuration and execute boot commands</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>This all happens on the Boot Processor (BP)</p>
</blockquote>
<h4 id="processor-startup">Processor Startup</h4>
<ul>
<li>Start processor <strong>P</strong> (Boot-processor)<ol>
<li>Setup boot program (<code>Machine.InitProcessors</code>)</li>
<li>Enter processor IDs into table (<code>Machine.InitBootPage</code>)</li>
<li>Send <em>startup</em> message to <strong>P</strong> via APIC (<code>Machine.ParseMPConfig</code>)</li>
<li>Wait with timeout on <em>started</em> flag by P (<code>Machine.StartProcessor</code>)</li>
</ol>
</li>
<li>Boot program (For each processor)<ol>
<li>Set 32-bit run-time environment (<code>Machine.EnterMP</code>)</li>
<li>Initializer control registers, memory management, interrupt handling, APIC</li>
<li>Set <em>started</em> flag (<code>Machine.StartMP</code>)</li>
<li>Setup Scheduler (<code>Objects.Start</code>)</li>
<li>Boot-processor proceeds with boot console</li>
</ol>
</li>
</ul>
<h3 id="a2-activities-states">A2 Activities States</h3>
<ul>
<li>Ready: ready to be scheduled</li>
<li>Running: currently scheduled</li>
<li>Waiting<ul>
<li>Condition (<code>AWAIT</code>): waiting until condition is met</li>
<li>Lock (<code>EXCLUSIVE</code>): waiting to enter monitor</li>
</ul>
</li>
<li>Terminated: Activity finished executing</li>
</ul>
<blockquote>
<p>Java doesn't make difference between waiting on a condition or a lock.</p>
</blockquote>
<p><img alt="A2 Activities States" class="img-responsive" src="/images/syscon_a2_activieties_states.png"/></p>
<h3 id="run-time-data-structures">Run-Time Data Structures</h3>
<ul>
<li>Running Array/List<ul>
<li>One entry for each processor</li>
<li>Index: id of processor</li>
</ul>
</li>
<li>Object header (for each object)<ul>
<li>List of conditions (for each condition)</li>
<li>List of locks (for each monitor)</li>
</ul>
</li>
<li>Ready Queues/Heap<ul>
<li>Idle</li>
<li>Low</li>
<li>Medium</li>
<li>High</li>
<li>Garbage Collector (GC)</li>
<li>Real-time (RT)</li>
</ul>
</li>
<li>Interrupt Array (first level IRQ's)<ul>
<li>Index: IRQ number</li>
</ul>
</li>
</ul>
<h3 id="stack-management">Stack Management</h3>
<ul>
<li>Virtual addressing</li>
<li>Allocation in page units</li>
<li>Page fault for detecting stack overflow</li>
<li>Deallocate process stack via garbage collector (in process finalizer)</li>
<li>Life cycle:<ul>
<li>CreateProcess: Allocate first frame</li>
<li>Page fault: Allocate another frame</li>
<li>Finalize: Deallocate all frames</li>
</ul>
</li>
</ul>
<blockquote>
<p>Active Oberon has one shared memory for all processes!</p>
</blockquote>
<ul>
<li>One Heap for all processes (no heavy-weight processes)</li>
<li>Each process has own stack</li>
<li>All processes share same address space</li>
<li>8'000 processes can be allocated<ul>
<li>4 GB address space</li>
<li>4 kB pages</li>
<li>1024 pages per process</li>
<li>↳ ~ 8'000 processes</li>
</ul>
</li>
</ul>
<h3 id="context-switch">Context Switch</h3>
<ul>
<li>Synchronous<ul>
<li>Explicit<ul>
<li>A process terminates</li>
<li><code>Yield</code></li>
</ul>
</li>
<li>Implicit<ul>
<li>Mutual exclusion</li>
<li><code>AWAIT</code></li>
</ul>
</li>
</ul>
</li>
<li>Asynchronous<ul>
<li>Preemption<ul>
<li>Priority handling</li>
<li>Time-slicing</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="coroutines-synchronous">Coroutines (Synchronous)</h4>
<ul>
<li>Synchronous context switch</li>
<li>Context switch:<ul>
<li>Replace <em>SP</em> and <em>FP</em> of old process with <em>SP</em> and <em>FP</em> of new process</li>
<li><em>PC</em> needs also to be adjusted</li>
</ul>
</li>
<li>Stack can be used to identify process</li>
</ul>
<h4 id="asynchronous-context-switch">Asynchronous Context Switch</h4>
<ul>
<li>Needs to save much more than for a synchronous context switch</li>
<li>Save <em>all registers</em> (copy state)</li>
</ul>
<h3 id="synchronisation">Synchronisation</h3>
<h4 id="object-locking">Object Locking</h4>
<ul>
<li>
<p>Object descriptors (added by system): Object with mutual exclusion contain additional fields</p>
<ul>
<li><code>headerLock: BOOLEAN;</code></li>
<li><code>lockedBy: Process;</code></li>
<li><code>awaitingLock: ProcessQueue;</code></li>
<li><code>awaitingCondition: ProcessQueue;</code></li>
</ul>
</li>
<li>
<p>Locking (Procedure <code>Lock</code>)</p>
<ul>
<li>Try to acquire object<ul>
<li>when we have it, we can change the data structure</li>
<li>if we don't have it (we need to give up control)<ul>
<li>Synchronous switching to an other process</li>
<li><code>Select</code> and <code>SwitchTo</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Unlocking (Procedure <code>Unlock</code>)<ul>
<li>When giving up a lock all conditions need to be evaluated again (signal-and-exit)</li>
<li>Otherwise the opposite of locking</li>
</ul>
</li>
<li>Wait Conditions (<code>AWAIT</code>)<ul>
<li>Internally boxed into a procedure (<code>PROCEDURE $Condition(fp: ADDRESS): BOOLEAN;</code>)</li>
<li>Stack frame is needed in condition: <em>FP</em></li>
<li><code>AWAIT</code> code: put condition on await queue</li>
</ul>
</li>
</ul>
<blockquote>
<p>Side-effects in <code>AWAIT</code> conditions are dangerous!</p>
</blockquote>
<h4 id="priority-inversion">Priority Inversion</h4>
<p>Example:</p>
<ul>
<li>3 processes, 1 shared resource<ul>
<li>P1: low</li>
<li>P2: high</li>
<li>P3: medium</li>
<li>R: shared resource</li>
</ul>
</li>
<li>P1 locks R</li>
<li>P2 tries to lock R (needs to wait)</li>
<li>P3 preempts P1<ul>
<li>P1 can't release R</li>
<li>P2 can't continue until P1 releases R</li>
</ul>
</li>
</ul>
<p><img alt="Priority Inversion" class="img-responsive" src="/images/syscon_priority_inversion.png"/></p>
<p>This image is taken from the lecture slides provided by Felix Friedrich</p>
<h4 id="priority-inheritance">Priority Inheritance</h4>
<ul>
<li>One possibility to cope with priority inversion</li>
<li>The priority of each process holding a lock to a resource is increased to the highest priority of all waiting processes (for the lock)</li>
<li>Need to walk the graph of locks and processes</li>
</ul>
<!-- End of Notes Week 7 -->
<!-- Beginning of Notes Week 8 -->
<h3 id="lock-free-programming">Lock-Free Programming</h3>
<p>Problems with Locks</p>
<ul>
<li>Deadlocks</li>
<li>Livelocks</li>
<li>Starvation</li>
</ul>
<p>Different Goals</p>
<ul>
<li>Parallelism</li>
<li>Progress Guarantees</li>
<li>Reentrancy</li>
<li>Granularity</li>
<li>Fault Tolerance</li>
</ul>
<p>Definition of Lock-Freedom</p>
<blockquote>
<p>At least one algorithm (process, thread) makes progress, even if others run concurrently, fail or get suspended.</p>
</blockquote>
<ul>
<li>Starvation can still happen</li>
</ul>
<p>Definition of Wait-Freedom</p>
<blockquote>
<p>Each algorithm makes eventually progress.</p>
</blockquote>
<ul>
<li>Implies freedom from starvation</li>
</ul>
<p>Progress Conditions:</p>
<table class="table table-hover table-striped">
<thead>
<tr>
<th></th>
<th>Blocking</th>
<th>Non-Blocking</th>
</tr>
</thead>
<tbody>
<tr>
<td>Someone make progress</td>
<td>Deadlock-free</td>
<td>Lock-free</td>
</tr>
<tr>
<td>Everyone makes progress</td>
<td>Starvation-free</td>
<td>Wait-free</td>
</tr>
</tbody>
</table>
<ul>
<li>Lock-free programming basically makes loop around CAS</li>
<li>Overflows (i.e INTEGER) is critical</li>
</ul>
<h4 id="a2">A2</h4>
<h5 id="goals">Goals</h5>
<ul>
<li>Lock Freedom<ul>
<li>Progress Guarantees</li>
<li>Reentrant Algorithms</li>
</ul>
</li>
<li>Portability<ul>
<li>Hardware Independence</li>
<li>Simplicity, Maintenance</li>
</ul>
</li>
</ul>
<h5 id="guiding-principles">Guiding Principles</h5>
<ul>
<li>Use <em>implicit cooperative multitasking</em></li>
<li>no virtual memory</li>
<li>possible optmizations are limited</li>
<li>Co-design of OS, Compiler and Programming Language</li>
</ul>
<h5 id="lock-free-kernel">Lock-Free Kernel</h5>
<ul>
<li>Needs lock-free queue</li>
<li>Compare-And-Swap (CAS) is implemented <em>wait-free</em> in hardware</li>
</ul>
<h5 id="memory-model-for-lock-free-active-oberon">Memory Model for Lock-Free Active Oberon</h5>
<ol>
<li>Data shared between two or more activities at the same time has to be either<ul>
<li>protected by <code>EXCLUSIVE</code> blocks or</li>
<li>read or modified using the <em>compare-and-swap</em> operation</li>
</ul>
</li>
<li>Changed shared data is visible to other activities after<ul>
<li>leaving an <code>EXCLUSIVE</code> block or</li>
<li>executing a <em>compare-and-swap</em> operation</li>
</ul>
</li>
</ol>
<ul>
<li>
<p><code>CAS</code> is an operation in the programming language</p>
<p>:::modula2
PROCEDURE CAS(variable, old, new: BaseType): BaseType</p>
</li>
<li>
<p>Performance of <code>CAS</code></p>
<ul>
<li>On the HW level <code>CAS</code> triggers a memory barrier</li>
<li>Performance suffers with increasing number of contenders (contention)</li>
</ul>
</li>
</ul>
<h4 id="aba-problem">ABA Problem</h4>
<p>The <a href="https://en.wikipedia.org/wiki/ABA_problem">ABA Problem</a> occurs when one thread
fails to recognise that a memory location was
modified temporarily by another thread and therefore erroneously assumes
that the overall state has not been changed.</p>
<p><img alt="ABA Problem" class="img-responsive" src="/images/syscon_aba_problem.png"/></p>
<p>This image is taken from the lecture slides provided by Felix Friedrich</p>
<ul>
<li>The ABA Problem makes it difficult to reuse nodes in a stack structure<ul>
<li>Possible to allocate always new memory, but it's expensive</li>
</ul>
</li>
<li>Solution: hazard pointers</li>
</ul>
<h5 id="hazard-pointers">Hazard Pointers</h5>
<ul>
<li>ABA Problem because of reuse of pointers<ul>
<li>Pointer <em>P</em> that has been read by one thread <em>X</em> but not yet written by same thread</li>
<li>Pointer <em>P</em> is written by other thread <em>Y</em> between reading and writing of first thread <em>X</em></li>
</ul>
</li>
<li>[Hazard pointers](https://en.wikipedia.org/wiki/Hazard_pointer:<ul>
<li>Each lock-free data structure has an array (hazard array) of the size of number of threads (n=number of threads)</li>
<li>Before <em>X</em> reads <em>P</em>, it marks it hazardous in the hazard array of data structure (e.g. the stack)</li>
<li>When finished (after the <code>CAS</code>), process <em>X</em> removes <em>P</em> from the hazard array</li>
<li>Before a process <em>Y</em> tries to reuse <em>P</em>, it checks all entries of the hazard array</li>
</ul>
</li>
<li>Hazard pointers don't solve problem when several pointers need to be changed at same time<ul>
<li>i.e Enqueue/Dequeue</li>
<li>Solution: use <em>sentinel</em><ul>
<li>Notion of helping other threads</li>
<li>Employ Hazard pointers
<!-- See Notes Week 8 p. 3 45:00 --></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="cooperative-multitasking-implicit">Cooperative Multitasking (implicit)</h3>
<ul>
<li>Compiler automatically inserts code for cooperative multitasking (implicit)</li>
<li>Each process has a quantum</li>
</ul>
<p>At regular intervals, the compiler inserts code to decrease the quantum and calls the scheduler if necessary</p>
<div class="highlight"><pre>   <span class="nf">sub</span>    <span class="p">[</span><span class="nb">rcx</span> <span class="o">+</span> <span class="mi">88</span><span class="p">],</span> <span class="mi">10</span>   <span class="c1">; decrement quantum by 10</span>
   <span class="nf">jge</span>    <span class="nv">skip</span>             <span class="c1">; check if it is negative (jump if greater)</span>
   <span class="nf">call</span>   <span class="nv">Switch</span>           <span class="c1">; perform task switch</span>
<span class="nl">skip:</span>
   <span class="c1">; ...</span>
</pre></div>
<ul>
<li>Uncooperative block (<code>UNCOOPERATIVE</code>): Guarantee that no scheduling happens<ul>
<li>Not like a <em>lock</em> different processors can execute the code in parallel</li>
<li>like disabling interrupts</li>
</ul>
</li>
<li>Cons<ul>
<li>Small overhead of inserted code</li>
<li>Sacrifice register (<code>rcx</code>)</li>
</ul>
</li>
<li>Guarantees<ul>
<li>Max number of parallel execution of uncooperative code is number of processors</li>
<li>Hazard pointer can be associated with processor (instead of processes)</li>
<li>Search time constant: thread-local storage → processor local storage</li>
</ul>
</li>
</ul>
<h4 id="interrupts">Interrupts</h4>
<ul>
<li>Interrupt handlers are modeled as <em>virtual</em> processors</li>
<li>M = # of physical processors + # of potentially concurrent interrupts</li>
</ul>
<!-- End of Week 8 -->
<!-- Beginning of Week 9 -->
<h4 id="queue-data-structures">Queue Data Structures</h4>
<p><img alt="Queue Data Structures" class="img-responsive" src="/images/syscon_queue_data_structure.png"/></p>
<p>This image is taken from the lecture slides provided by Felix Friedrich</p>
<ul>
<li>Hazard Pointers: in use (writing)</li>
<li>Pool: Reuse nodes that are not used anymore</li>
<li>Lock-free but not wait-free (starvation possible)</li>
<li>if not possible to en-/dequeue: help other threads (processors)</li>
</ul>
<h5 id="scheduling-activities">Scheduling (Activities)</h5>
<div class="highlight"><pre><span class="kr">TYPE</span> <span class="n">Activity</span><span class="o">*</span> <span class="o">=</span> <span class="n">OBJECT</span> <span class="p">{</span><span class="n">DISPOSABLE</span><span class="p">}</span> <span class="p">(</span><span class="n">Queues</span><span class="p">.</span><span class="n">Item</span><span class="p">)</span> <span class="cm">(* Queues.Item accessed via activity register *)</span>
<span class="kr">VAR</span>
    <span class="cm">(* access to current processor *)</span>
    <span class="cm">(* stack management *)</span>
    <span class="cm">(* quantum and scheduling *)</span>
    <span class="cm">(* active object *)</span>
<span class="kr">END</span> <span class="n">Activity</span><span class="p">;</span>
</pre></div>
<h5 id="task-switch-finalizer">Task Switch Finalizer</h5>
<p>Finest granular protection makes <strong>races</strong> possible that did not occur previously:</p>
<p>Need to pass information to the new thread.</p>
<div class="highlight"><pre><span class="n">current</span> <span class="o">:=</span> <span class="n">GetCurrentTask</span><span class="p">()</span>
<span class="n">next</span> <span class="o">:=</span> <span class="n">Dequeue</span><span class="p">(</span><span class="n">readyqueue</span><span class="p">)</span>
<span class="n">Enqueue</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">readyqueue</span><span class="p">)</span>
<span class="cm">(* Here an other thread can dequeue and run (on the stack of)</span>
<span class="cm">   the currently executing thread! *)</span>
<span class="n">SwitchTo</span><span class="p">(</span><span class="n">next</span><span class="p">)</span>
</pre></div>
<ul>
<li>When switching to new thread<ul>
<li>Enqueue runs on new thread</li>
<li>Call finalizer of previous thread</li>
</ul>
</li>
</ul>
<p>Solution with finalizer:</p>
<div class="highlight"><pre><span class="n">SwitchTo</span> <span class="p">(</span><span class="n">nextActivity</span><span class="p">,</span> <span class="n">Enqueue</span><span class="p">,</span>  <span class="cm">(* Enqueue runs on new thread *)</span>
          <span class="n">ADDRESS</span> <span class="kr">OF</span> <span class="n">readyQueue</span><span class="p">[</span><span class="n">currentActivity</span><span class="p">.</span><span class="n">priority</span><span class="p">]);</span>
<span class="n">FinalizeSwitch</span><span class="p">;</span> <span class="cm">(* Calls finalizer of previous thread *)</span>
</pre></div>
<h4 id="stack-management_1">Stack Management</h4>
<ul>
<li>Stacks organized as Heap Blocks</li>
<li>Stack check instrumented at beginning of procedure</li>
<li>Stack expansion is possible</li>
<li>Possibilities to expand stack:<ol>
<li>Allocate more memory for stack, copy old stack to beginning of new (pointers to stack need to be updated <code>VAR</code> parameters)</li>
<li>Manage stack in a linked list, link to new portion of stack from the old one: <code>ReturnToStackSegment</code> function needed to go back to previous stack segment</li>
</ol>
</li>
</ul>
<h5 id="interrupts_1">Interrupts</h5>
<ul>
<li>First Level IRQ by non-portable CPU module</li>
<li>Second level IRQ handling with activities</li>
</ul>
<p>Wait for interrupt:</p>
<div class="highlight"><pre><span class="n">Interrupts</span><span class="p">.</span><span class="n">Await</span><span class="p">(</span><span class="n">interrupt</span><span class="p">);</span>
</pre></div>
<p>First level IRQ code affecting scheduler queues runs on a virtual processor</p>
<div class="highlight"><pre><span class="kr">PROCEDURE</span> <span class="n">Handle</span> <span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="k-Pervasive">SIZE</span><span class="p">);</span>
<span class="kr">BEGIN</span> <span class="p">{</span><span class="n">UNCOOPERATIVE</span><span class="p">,</span> <span class="n">UNCHECKED</span><span class="p">}</span>
    <span class="kr">IF</span> <span class="n">previousHandlers</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">#</span> <span class="k-Pervasive">NIL</span> <span class="kr">THEN</span>
        <span class="n">previousHandlers</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">(</span><span class="n">index</span><span class="p">)</span>
    <span class="kr">END</span><span class="p">;</span>
    <span class="n">Activities</span><span class="p">.</span><span class="n">CallVirtual</span><span class="p">(</span><span class="n">NotifyNext</span><span class="p">,</span>
                           <span class="n">ADDRESS</span> <span class="kr">OF</span> <span class="n">awaitingQueues</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
                           <span class="n">processors</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
<span class="kr">END</span> <span class="n">Handle</span><span class="p">;</span>
</pre></div>
<ul>
<li>Very powerful to write IRQ handlers in to levels</li>
<li>Possible with cooperative multitasking</li>
</ul>
<h5 id="lock-free-memory-management">Lock-Free Memory Management</h5>
<ul>
<li>Allocation/Deallocation by lock-free algorithms</li>
<li>Buddy system: old approach but simple when returning blocks and merging them in free memory</li>
<li>Mark-and-sweep<ol>
<li>Traverse heap and mark used blocks</li>
<li>Remove all unmarked blocks</li>
</ol>
</li>
<li>Multiple garbage collectors can run in parallel</li>
<li>Precise: doesn't delete used blocks by accident (can happen in GC with heuristics)</li>
<li>Optional</li>
<li>Incremental: Possible to run on a subset all blocks (on different parts of heap)</li>
<li>Concurrent: GC can run in concurrency of a mutating thread</li>
<li>Parallel: Several instances of the GC can run at once</li>
</ul>
<p>Data Structures:</p>
<table class="table table-hover table-striped">
<thead>
<tr>
<th></th>
<th>Global</th>
<th>Per Object</th>
</tr>
</thead>
<tbody>
<tr>
<td>Mark Bit</td>
<td>Cycle Count</td>
<td>Cycle Count</td>
</tr>
<tr>
<td>Marklist</td>
<td>Marked First</td>
<td>Next Marked</td>
</tr>
<tr>
<td>Watchlist</td>
<td>Watched First</td>
<td>Next Watched</td>
</tr>
<tr>
<td>Root Set</td>
<td>Global References</td>
<td>Local Refcount</td>
</tr>
</tbody>
</table>
<ul>
<li>Cycle Count: used to mark visited objects</li>
<li>Mark List: all objects that were marked previously</li>
<li>Watch List: all candidates that could be garbage collected</li>
<li>Root Set: where to start to find all reachable object</li>
</ul>
<h3 id="portability">Portability</h3>
<ul>
<li>Lock-free A2 kernel written exclusively in a high-level language</li>
<li>No timer interrupt required (cooperative multitasking): scheduler hardware independent</li>
<li>No virtual memory<ul>
<li>no separate address spaces</li>
<li>everything runs in user mode, all the time</li>
</ul>
</li>
<li>Hardware-dependent functions (CAS) are pushed into the language</li>
<li>Almost completely portable:<ul>
<li>Some minimal stub written in assembly code to initialize memory mappings and initialize all processors</li>
</ul>
</li>
</ul>
<!-- End of Notes Week 9 -->
<!-- Beginning of Notes Week 10 -->
<h1 id="oberon-risc-case-study-3">Oberon RISC (Case Study 3)</h1>
<p><a href="http://www.projectoberon.com/">Project Oberon</a></p>
<ul>
<li>RISC architecture</li>
<li>Oberon OS</li>
<li>Motivation: Build system from scratch</li>
<li>Understanding a big amount of details</li>
<li>Commercial systems are far from perfect</li>
<li>Need good tools for programming</li>
<li>Competence for building from Scratch: HW, application, how it really works</li>
<li>'lean systems' approach</li>
<li>Build from scratch<ul>
<li>reduce complexity: no 'baggage'</li>
<li>choices of different implementation</li>
<li>design based only on problem domain and experience</li>
<li>less surprises!</li>
<li>flexible solutions</li>
<li>more than customer needs</li>
<li>competitive advantages</li>
</ul>
</li>
<li>Why not build from scratch<ul>
<li>re-inventing the wheel</li>
<li>fundamental knowledge required</li>
<li>more actual work (the first time)</li>
<li>restricted component choices</li>
<li>not for short-term!</li>
<li>team work: communication!</li>
</ul>
</li>
<li>Configurable Hardware<ul>
<li>PAL's / GAL's / CPLD's</li>
<li>LUT and interconnect</li>
<li>Current: FPGA</li>
<li>loadable configuration (not like ASIC/VLSI)</li>
</ul>
</li>
<li>Introduction to HDL:<ul>
<li>Simulation / Synthesis</li>
<li>Verilog / VHDL</li>
<li>Developed at ETH: Lola, ActiveCells</li>
<li>Very different from Programming Languages</li>
<li>Things happen in parallel (not serial)!</li>
<li>Very difficult for high frequencies</li>
</ul>
</li>
<li>RISC architecture (overview)<ul>
<li><a href="https://www.inf.ethz.ch/personal/wirth/FPGA-relatedWork/RISC-Arch.pdf">Documentation</a></li>
<li>Developed by N. Wirth</li>
<li>Used for book "Compiler Construction" by N. Wirth</li>
<li>RISC vs. CISC</li>
<li>Harward vs. Von Neumann</li>
<li>Registers vs. Stack Machine</li>
<li>FPU</li>
<li>ALU</li>
<li>Shifter (Barrel-Shifter)</li>
<li>Implemented in Verilog</li>
<li>3 kinds of instructions
        - arithmetic/logic
        - load/store
        - floating-point</li>
<li>RISC processor executes SW</li>
<li>RISC0:<ul>
<li>Memory addressed as words</li>
</ul>
</li>
<li>RISC5:<ul>
<li>Memory can be addressed as bytes</li>
<li>Adds external static RAM</li>
<li>FPU</li>
<li>SPI, PS/2, GPIO, RS-233, 1 ms timer</li>
</ul>
</li>
<li>Top of stack: -64</li>
<li>Flags:<ul>
<li>Not equal</li>
<li>Zero</li>
<li>Carry/Borrow</li>
<li>Overflow</li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- End of Notes Week 10 -->
<!-- Beginning of Notes Week 11 -->
<ul>
<li>Co-design: OS/HW/Compiler</li>
<li>Minimalistic</li>
<li>Best practices from CS</li>
<li>Architecture/Features<ul>
<li>Fast file system, module loader, garbage collector</li>
<li>High-level, type-save language</li>
<li>files</li>
<li><code>Module.Command[params]</code> execution from any visual text</li>
<li>self hosted, small (~200kB)</li>
</ul>
</li>
<li>User Interface<ul>
<li>Mouse oriented, three buttons, "interclicking"</li>
</ul>
</li>
<li>Oberon Core System<ul>
<li>Inner/Outer core</li>
<li>File system: FileDir, File</li>
<li>Networking</li>
<li>Outer core: input, viewers, fonts, text, ...</li>
<li>Compiler: recursive descent, single pass</li>
<li>RS-232, SCC, Net</li>
<li>no memory protection</li>
<li>possible to draw over other windows</li>
<li>no auto save</li>
</ul>
</li>
<li>Boot loader<ul>
<li>loads boot file (inner core) form SD-card (or serial port)</li>
</ul>
</li>
<li>Simple to build own tools build on Oberon System</li>
<li><a href="https://github.com/pdewacht/oberon-risc-emu">RISC emulator</a> available</li>
</ul>
<!-- End of Notes Week 11 -->
<!-- Beginning of Notes Week 12 -->
<h1 id="active-cells-case-study-4">Active Cells (Case Study 4)</h1>
<ul>
<li>
<p>Custom design of Multi-Processor System</p>
<ul>
<li>Cores</li>
<li>Caches</li>
<li>Bus</li>
<li>Memory</li>
</ul>
</li>
<li>
<p>Each process owns it's core</p>
<ul>
<li>Scheduling unnecessary</li>
<li>Caches unnecessary</li>
<li>some restrictions / some improvements</li>
</ul>
</li>
<li>
<p>Tiny Register Machines (TRM)</p>
<ul>
<li>TRM interconnects</li>
<li>SW/HW Co-design</li>
<li>Active Cells Tool-chain</li>
</ul>
</li>
<li>Multi-core Systems Challenges<ul>
<li>Cache coherence</li>
<li>Shared memory communication bottleneck</li>
<li>Thread synchronization overhead</li>
<li>Difficult to predict behaviour and timing</li>
<li>Hard to scale</li>
<li><a href="https://de.wikipedia.org/wiki/Partitioned_Global_Address_Space">Partitioned Global Address Space</a></li>
</ul>
</li>
<li>Operating System Challenges<ul>
<li>Processor Time Sharing<ul>
<li>Interrupts</li>
<li>Context Switches</li>
<li>Thread Synchronisation</li>
</ul>
</li>
<li>Memory Sharing<ul>
<li>Inter-process: Paging</li>
<li>Intra-process, Inter-Thread: Monitors</li>
</ul>
</li>
</ul>
</li>
<li>Project Supercomputer in the Pocket<ul>
<li>Focus: Streaming Applications (i.e ECG)</li>
<li>Stream Parallelism (pipelining)</li>
<li>Task parallelism / data parallelism</li>
</ul>
</li>
<li>On-chip distributed system<ul>
<li>Replace shared memory by local memory<ul>
<li>Message passing for interaction between processes</li>
</ul>
</li>
<li>Separate processor for each process<ul>
<li>Very simple processors</li>
<li>No scheduling, no interrupts</li>
<li>Application-aware processors</li>
</ul>
</li>
<li>Minimal operating system</li>
<li>Conceptually no memory bottleneck</li>
<li>Higher reliability and predictability by design</li>
</ul>
</li>
</ul>
<h2 id="tiny-register-machine-trm">Tiny Register Machine (TRM)</h2>
<ul>
<li>Extremely simple porcessor on FPGA</li>
<li>Hardware architecture</li>
<li>Two-stage pipeline</li>
<li>Each TRM contains<ul>
<li>ALU and shifter</li>
<li>32-bit operands and results stored in a bonak of 2 * 8 registers</li>
<li>Local data memory: d * 512 words of 32 bits</li>
<li>Local program memory: i * 1024 instructions with 32 bits</li>
<li>7 general purpose registers</li>
<li>Register <em>H</em> for storing the high 32 bits of a product</li>
<li>4 conditional registers: <em>C</em>, <em>N</em>, <em>V</em>, <em>Z</em></li>
<li>no chaches
TRM Machine Language</li>
</ul>
</li>
<li>Machine language: binary representation of instructions</li>
<li>18-bit instructions</li>
<li>Three instruction types:<ol>
<li>Type a: arithmetical and logical operations</li>
<li>Type b: load and store instructions</li>
<li>Type c: branch instructions (for jumping)</li>
</ol>
</li>
<li>Instruction Encoding: Offset and Immediate values have restricted width<ul>
<li>Long jumps constructed from chains</li>
<li>Immediate store/load with shifts</li>
</ul>
</li>
<li>Variants of TRMs<ul>
<li>FTRM: includes FPU</li>
<li>VTRM: includes vector processing unit<ul>
<li>8 x 8-words registers</li>
<li>available with/without FPU</li>
</ul>
</li>
<li>TRM with SW configurable instruction width</li>
</ul>
</li>
<li>First Experiment: TRM12<ul>
<li>Message passing architecture</li>
<li>Bus based on chip interconnect</li>
<li>Not scalable</li>
</ul>
</li>
<li>Second Experiment: Ring of 12 TRMs<ul>
<li>TRM ↔ Adapter ↔ Ring</li>
<li>Not scalable</li>
<li>Large delays</li>
</ul>
</li>
</ul>
<h2 id="active-cells">Active Cells</h2>
<ul>
<li>Computing model, programming language</li>
<li>Compiler, synthesizer, hardware library, simulator</li>
<li>Programmable HW (FPGA)</li>
<li>One toolchain for SW and HW</li>
<li>Consequences<ul>
<li>No global memory</li>
<li>No processor sharing</li>
<li>No pecularites of specific processor</li>
<li>No predefined topology (NoC)</li>
<li>No interrupts</li>
<li>No operation system</li>
</ul>
</li>
<li>Computation units: <em>Cells</em></li>
<li>Different parallelism levels:<ul>
<li>Communication Structure (Pipelining, Parallel Execution)</li>
<li>Cell Capabilities (Vector Computing, Simultaneous Execution)</li>
</ul>
</li>
<li>Inspired by: Kahn Process Networks, Dataflow Programming, CSP</li>
<li>Active Cell Component<ul>
<li>Active Cell<ul>
<li>Object with private state space</li>
<li>Integrated control thread(s)</li>
<li>Connected via channels</li>
</ul>
</li>
<li>Cell Net<ul>
<li>Network of communication cells</li>
</ul>
</li>
</ul>
</li>
<li>Active Cells<ul>
<li>Scope and environment for a running isolated process</li>
<li>Cells do not share memory</li>
<li>Defined as types with port parameters</li>
</ul>
</li>
</ul>
<p>Example:</p>
<div class="highlight"><pre><span class="kr">TYPE</span>
    <span class="n">Adder</span> <span class="o">=</span> <span class="n">cell</span> <span class="p">(</span><span class="n">in1</span><span class="p">,</span> <span class="n">in2</span><span class="p">:</span> <span class="n">port</span> <span class="n">in</span><span class="p">;</span> <span class="n">result</span><span class="p">:</span> <span class="n">port</span> <span class="n">out</span><span class="p">);</span> <span class="cm">(* communication ports *)</span>
    <span class="kr">VAR</span> <span class="n">summand1</span><span class="p">,</span> <span class="n">summand2</span><span class="p">:</span> <span class="n">integer</span><span class="p">;</span>
    <span class="kr">BEGIN</span>
        <span class="n">in1</span> <span class="err">?</span> <span class="n">summand1</span><span class="p">;</span> <span class="cm">(* blocking receive *)</span>
        <span class="n">in2</span> <span class="err">?</span> <span class="n">summand2</span><span class="p">;</span>
        <span class="n">result</span> <span class="err">!</span> <span class="n">summand1</span> <span class="o">+</span> <span class="n">summand2</span><span class="p">;</span> <span class="cm">(* non-blocking send *)</span>
    <span class="kr">END</span> <span class="n">Adder</span><span class="p">;</span>
</pre></div>
<p>Cell Constructors to parameterize cells during allocation time:</p>
<div class="highlight"><pre><span class="kr">TYPE</span>
    <span class="n">Filter</span> <span class="o">=</span> <span class="n">cell</span> <span class="p">(</span><span class="n">in</span><span class="p">:</span> <span class="n">port</span> <span class="n">in</span><span class="p">;</span> <span class="n">result</span><span class="p">:</span> <span class="n">port</span> <span class="n">out</span><span class="p">);</span>
    <span class="kr">VAR</span> <span class="o">..</span><span class="p">.;</span> <span class="n">filterLength</span><span class="p">:</span> <span class="n">integer</span><span class="p">;</span>
    <span class="kr">PROCEDURE</span> <span class="o">&amp;</span> <span class="n">Init</span><span class="p">(</span><span class="n">filterLength</span><span class="p">:</span> <span class="n">integer</span><span class="p">)</span>  <span class="cm">(* constructor *)</span>
    <span class="kr">BEGIN</span> <span class="n">self</span><span class="p">.</span><span class="n">filterLength</span> <span class="o">:=</span> <span class="n">filterLength</span>
    <span class="kr">END</span> <span class="n">Init</span><span class="p">;</span>
<span class="kr">BEGIN</span>
    <span class="cm">(* ... filter action ... *)</span>
<span class="kr">END</span> <span class="n">Filter</span><span class="p">;</span>

<span class="kr">VAR</span> <span class="n">filter</span><span class="p">:</span> <span class="n">Filter</span><span class="p">;</span>
<span class="kr">BEGIN</span>
    <span class="o">....</span> <span class="n">new</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span> <span class="cm">(* initialization parameter filterlength = 32 *)</span>
</pre></div>
<p>Cells can be parametrized with capabilities or non-default values:</p>
<div class="highlight"><pre><span class="kr">TYPE</span>
  <span class="cm">(* Cell is a VectorTRM with 2k of Data Memory and has access to DDR2 memory *)</span>
  <span class="n">Filter</span> <span class="o">=</span> <span class="n">cell</span> <span class="p">{</span><span class="n">Vector</span><span class="p">,</span> <span class="n">DataMemory</span><span class="p">(</span><span class="mi">2048</span><span class="p">),</span> <span class="n">DDR2</span><span class="p">}</span> <span class="p">(</span><span class="n">in</span><span class="p">:</span> <span class="n">port</span> <span class="n">in</span> <span class="p">(</span><span class="mi">64</span><span class="p">);</span> <span class="n">result</span><span class="p">:</span> <span class="n">port</span> <span class="n">out</span><span class="p">);</span>
                                         <span class="cm">(* in port is implemented with width of 64 bits *)</span>
  <span class="kr">VAR</span> <span class="o">..</span><span class="p">.</span>
  <span class="kr">BEGIN</span>
      <span class="cm">(* ... filter action ... *)</span>
  <span class="kr">END</span> <span class="n">Filter</span><span class="p">;</span>
</pre></div>
<ul>
<li>Hierarchic Composition: Cell Nets<ul>
<li>Allocation of cells: <code>new</code> statement</li>
<li>Connection of cells: <code>connect</code> statement</li>
<li>Ports of cells can be delegated to the ports of the net: <code>delegate</code> statement</li>
<li>Terminal or closed Cellnets (i.e Cellnets witout ports) can be deployed to hardware</li>
</ul>
</li>
</ul>
<p>Terminal Cellnet Example</p>
<div class="highlight"><pre><span class="n">cellnet</span> <span class="n">Example</span><span class="p">;</span>
<span class="n">import</span> <span class="n">RS232</span><span class="p">;</span>
<span class="kr">TYPE</span>
    <span class="n">UserInterface</span> <span class="o">=</span> <span class="n">cell</span> <span class="p">{</span><span class="n">RS232</span><span class="p">}(</span><span class="n">out1</span><span class="p">,</span> <span class="n">out2</span><span class="p">:</span> <span class="n">port</span> <span class="n">out</span><span class="p">;</span> <span class="n">in</span><span class="p">:</span> <span class="n">port</span> <span class="n">in</span><span class="p">)</span>
    <span class="cm">(* ... *)</span>
    <span class="kr">END</span> <span class="n">UserInterface</span><span class="p">;</span>

    <span class="n">Adder</span> <span class="o">=</span> <span class="n">cell</span><span class="p">(</span><span class="n">in1</span><span class="p">,</span> <span class="n">in2</span><span class="p">:</span> <span class="n">port</span> <span class="n">in</span><span class="p">;</span> <span class="n">out</span><span class="p">:</span> <span class="n">port</span> <span class="n">out</span><span class="p">)</span>
    <span class="cm">(* ... *)</span>
    <span class="kr">END</span> <span class="n">Adder</span><span class="p">;</span>
    <span class="kr">VAR</span> <span class="n">interface</span><span class="p">:</span> <span class="n">UserInterface</span><span class="p">;</span> <span class="n">adder</span><span class="p">:</span> <span class="n">Adder</span>
    <span class="kr">BEGIN</span>
        <span class="n">new</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
        <span class="n">new</span><span class="p">(</span><span class="n">adder</span><span class="p">);</span>
        <span class="n">connect</span><span class="p">(</span><span class="n">interface</span><span class="p">.</span><span class="n">out1</span><span class="p">,</span> <span class="n">adder</span><span class="p">.</span><span class="n">in1</span><span class="p">);</span>
        <span class="n">connect</span><span class="p">(</span><span class="n">interface</span><span class="p">.</span><span class="n">out2</span><span class="p">,</span> <span class="n">adder</span><span class="p">.</span><span class="n">in2</span><span class="p">);</span>
        <span class="n">connect</span><span class="p">(</span><span class="n">adder</span><span class="p">.</span><span class="n">result</span><span class="p">,</span> <span class="n">interface</span><span class="p">.</span><span class="n">in</span><span class="p">);</span>
<span class="kr">END</span> <span class="n">Example</span><span class="p">.</span>
</pre></div>
<ul>
<li>Communication between cells (CSP)<ul>
<li>Receiving is blocking (<code>?</code>)</li>
<li>Sending is non-blocking (<code>!</code>)</li>
</ul>
</li>
<li>Engine Cell Made From Hardware (in HW library for FPGA)</li>
</ul>
<p>-Hardware Library
    - Computation Components
        - General purpose minimal machine: TRM, FTRM
        - Vector machine: VTRM
        - MAC, Filters etc.
    - Communication Components (FIFOs)
        - 32 * 128
        - 512 * 128
        - 32, 64, 128, 1k * 32
    - Storage Components
        - DDR2 controller
        - configurable BRAMs
        - CF controller
    - I/O Components
        - UART controller
        - LCD, LED controller
        - SPI, I2C controller
        - VGA, DVI controller</p>
<!-- End of Notes Week 12 -->
<!-- Beginning of Notes Week 13 -->
<h2 id="programming-language-vs-hdl">Programming Language vs. HDL</h2>
<h3 id="programming-language">Programming Language</h3>
<ul>
<li>Sequential execution</li>
<li>No notion of time</li>
</ul>
<p>Example:
    :::modula2
    VAR a,b,c: INTEGER;
    a := 1;      (<em> unknown </em>)
    b := 2;      (<em> mapping to </em>)
    c := a + b;  (<em> machine cycles </em>)</p>
<h3 id="hardware-description-language">Hardware Description Language</h3>
<p>Continuous execution (combinational logic):</p>
<div class="highlight"><pre><span class="kt">wire</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">;</span>
<span class="k">assign</span> <span class="n">c</span><span class="o">=</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">;</span> <span class="c1">// no</span>
<span class="k">assign</span> <span class="n">a</span><span class="o">=</span><span class="mh">1</span><span class="p">;</span>   <span class="c1">// memory</span>
<span class="k">assign</span> <span class="n">b</span><span class="o">=</span><span class="mh">2</span><span class="p">;</span>   <span class="c1">// associated</span>
</pre></div>
<p>Synchronous execution (register transfer):</p>
<div class="highlight"><pre><span class="kt">reg</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">;</span>

<span class="k">always</span> <span class="p">@</span> <span class="p">(</span><span class="k">posedge</span> <span class="n">clk</span><span class="p">)</span>
<span class="k">begin</span>
    <span class="n">a</span> <span class="o">&lt;=</span> <span class="mh">1</span><span class="p">;</span>    <span class="c1">// synchronous at</span>
    <span class="n">b</span> <span class="o">&lt;=</span> <span class="mh">2</span><span class="p">;</span>    <span class="c1">// rising edge</span>
    <span class="n">c</span> <span class="o">&lt;=</span> <span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">;</span>  <span class="c1">// of the clock</span>
<span class="k">end</span><span class="p">;</span>
</pre></div>
<!-- Notes Week 13 20:00 -->
<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width < 768) ? "left" : align;
        indent = (screen.width < 768) ? "0em" : indent;
        linebreak = (screen.width < 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    var location_protocol = (false) ? 'https' : document.location.protocol;
    if (location_protocol !== 'http' && location_protocol !== 'https') location_protocol = 'https:';
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = location_protocol + '//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
    mathjaxscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>
  </div>

  <hr/>

      <ul class="pager">
        <li class="previous">
          <a href="http://lukaswoodtli.github.io/hardware-software_codesign.html">
          &laquo; Newer</a>
        </li>
        <li class="next">
          <a href="http://lukaswoodtli.github.io/distance_functions_and_metrics.html">
          Older &raquo;</a>
        </li>
      </ul>


        </div>

        <div class="row">
        </div>

      </div>

      <div class="col-md-2">
      </div>
    </div>


  </div>

    <nav id="footer" class="navbar navbar-default">
    <div class="container">
        <p id="footer-text" class="navbar-text text-center">
          <span id="engine">
            Compiled using
            <a href="http://docs.getpelican.com">Pelican</a>
          </span>
          <span id="theme">
            with theme
            <a href="http://github.com/yuex/pelican-chameleon">Chameleon</a>
          </span>
          <span id="bootstrap">
            on top of
            <a href="http://getbootstrap.com/">Bootstrap</a>
          </span>
        </p>
      </div>
    </div>
  </nav>


</body>
</html>